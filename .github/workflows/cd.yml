name: CD - Deploy

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.dcmx.network
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
    
    - name: Build and push API image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.api
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:staging
        labels: ${{ steps.meta.outputs.labels }}
    
    - name: Build and push Worker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.worker
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/worker:staging
        labels: ${{ steps.meta.outputs.labels }}
    
    - name: Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:staging
        labels: ${{ steps.meta.outputs.labels }}
    
    - name: Deploy to Kubernetes (Staging)
      uses: azure/k8s-deploy@v4
      with:
        namespace: dcmx-staging
        manifests: |
          k8s/staging/api-deployment.yaml
          k8s/staging/worker-deployment.yaml
          k8s/staging/frontend-deployment.yaml
          k8s/staging/services.yaml
        images: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:staging
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/worker:staging
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:staging
      env:
        KUBECONFIG: ${{ secrets.KUBE_CONFIG_STAGING }}
    
    - name: Run database migrations
      run: |
        kubectl exec -n dcmx-staging deployment/dcmx-api -- \
          python -m alembic upgrade head
      env:
        KUBECONFIG: ${{ secrets.KUBE_CONFIG_STAGING }}
    
    - name: Smoke tests
      run: |
        echo "Waiting for deployment to stabilize..."
        sleep 30
        curl -f https://staging.dcmx.network/health || exit 1
        curl -f https://staging.dcmx.network/api/v1/health || exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://dcmx.network
    needs: []
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "version=latest" >> $GITHUB_OUTPUT
        fi
    
    - name: Build and push images with version
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.api
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:${{ steps.version.outputs.version }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:latest
    
    - name: Deploy to Production Kubernetes
      uses: azure/k8s-deploy@v4
      with:
        namespace: dcmx-production
        manifests: |
          k8s/production/api-deployment.yaml
          k8s/production/worker-deployment.yaml
          k8s/production/frontend-deployment.yaml
          k8s/production/services.yaml
          k8s/production/ingress.yaml
        images: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:${{ steps.version.outputs.version }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/worker:${{ steps.version.outputs.version }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ steps.version.outputs.version }}
      env:
        KUBECONFIG: ${{ secrets.KUBE_CONFIG_PRODUCTION }}
    
    - name: Database backup before migration
      run: |
        kubectl exec -n dcmx-production deployment/dcmx-postgres -- \
          pg_dump -U dcmx dcmx > backup-$(date +%Y%m%d-%H%M%S).sql
      env:
        KUBECONFIG: ${{ secrets.KUBE_CONFIG_PRODUCTION }}
    
    - name: Run database migrations
      run: |
        kubectl exec -n dcmx-production deployment/dcmx-api -- \
          python -m alembic upgrade head
      env:
        KUBECONFIG: ${{ secrets.KUBE_CONFIG_PRODUCTION }}
    
    - name: Health checks
      run: |
        echo "Waiting for deployment..."
        sleep 60
        curl -f https://dcmx.network/health || exit 1
        curl -f https://dcmx.network/api/v1/health || exit 1
    
    - name: Notify deployment
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'DCMX Production deployed: ${{ steps.version.outputs.version }}'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
